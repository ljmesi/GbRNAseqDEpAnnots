---
title: "Tuotteet ja niiden vuokraajat"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DT)
library(tidyverse)
library(crosstalk)
```









```{r luo_taulukko, echo=FALSE, warning=FALSE}
taulukko <- read_tsv("lris_lots_as_asr_tuo.tsv", col_types = "DfffcfffcdDDcdffccffff") %>% 
  filter(SOPPVM > "2010-01-01") %>%
  filter(RIVIYHT > 0) %>%
  filter(!str_detect(TRNIMI, "KULJETUSVELOTUS")) %>% 
  filter(!str_detect(TRNIMI, "LASKUTUSLISÄ")) %>% 
  filter(!str_detect(TRNIMI, "TERÄVELOTUS")) %>% 
  filter(!str_detect(VPAIVAT, "^-")) %>% 
  mutate(across(VPAIVAT, as.factor)) %>% 
  select(-c(LASKU, SOPNO, TOIMPVM, PALPVM, LASKASNO, ASRNO)) %>% 
  mutate(VP = fct_recode(VP,
    "Hki" = "1",
    "Vantaa" = "2")) %>% 
  rename("Sopimus pvm" = SOPPVM,
         'Tuoteryhmänro' = TRNRO,
         'Tuoteryhmänimi' = TRNIMI,
         'Tuotenro' = TUOTENO,
         'Tuotenimi' = NIMI_TYYPPI,
         'Vuokrapaikka' = VP,
         'Vuokrapäivät' = VPAIVAT,
         'Tulot' = RIVIYHT,
         'Selite' = SELITE,
         'Määrä' = MAARA,
         'Asiakasnro' = ASNRO,
         'Asiakkaan nimi' = NIMI,
         'Osoite' = OSOITE,
         'Postinumero' = PNRO,
         'Postitoimipaikka' = PTOIMIP,
         'Asiakasryhmänimi' = ASRNIMI
        ) 
  #dom <- 'tlrfpiB'
  dom <- 'tBlipr'
  buttons <- c('copy', 'csv', 'pdf', 'excel', 'print')
  #buttons <- c('csv')
  taulukko %>%
  datatable(rownames = FALSE,
            filter = 'top',
            options = list(pageLength = 10,
                          extensions = c('Buttons'),
                          DT.warn.size=FALSE,
                          dom = dom,
                          buttons = buttons,
                          lengthMenu = c(10, 30, 100)
                        )
           ) 
```

**Huom: Exportointi (etenkin Excel ja CSV tiedostoiksi) voi kestää jopa 5-6 minuuttia riippuen exportoitavan datan määrästä.**

Tämä yllä oleva taulukko on tuotettu kaikesta vuokrausdatasta poistamalla siitä kaikki:

- kuljetusvelotukset

- laskutuslisät

- terävelotukset

- sopimukset, joissa tulot olivat $\leq 0$

- sopimukset, joiden päivämäärä oli ennen 1.1.2010

- sopimukset, joissa vuokrapäivät olivat negatiivisia


```{r, include=FALSE}
# Tämä on outo juttu, mutta kun tämä on mukana niin yllä olevan taulukon painikkeet toimivat 
library(DT)
TableName <- 'Deal View'
eps <- 1E-5
report <-  paste0("function (e, dt, node, config) {reportIssue(e, dt, node, config, tableName =", "'", TableName, "'",  ");}")


datatable(
  iris, rownames=FALSE,
  extensions = 'Buttons',
  options = list(
    paging = FALSE, searching = FALSE, ordering=F, info = FALSE,
    dom = 'Bfrtip',
    buttons = list(
      list(
        extend = 'collection',
        text = '<i class="fa fa-bars"></i>',
        buttons = list(
          'copy', 'excel',
          list(extend = 'csv', text = 'Report Issue', action = JS(report))
        ), 
        text = 'Export'
      )
    )
  )
) 
```
